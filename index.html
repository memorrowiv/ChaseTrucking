<script>
    let enteredPassword = "";

    async function fetchPassword() {
        const scriptUrl = "https://script.google.com/macros/s/AKfycby4DoYAGHU7NEmdO0U9n2gnrKNefON3nAeoNIOYSgc5PE3QaOSh_nxgtEJ10n63rhLH/exec?action=getPassword";
        
        try {
            const response = await fetch(scriptUrl);
            const data = await response.json();
            console.log("Fetched password:", data.password); // Debug log
            return data.password;
        } catch (error) {
            console.error("Error fetching password:", error);
            return null;
        }
    }

    async function checkPassword() {
        console.log("checkPassword() triggered.");
        enteredPassword = prompt("Enter password to access:");

        if (!enteredPassword) {
            console.log("User canceled password prompt.");
            return;
        }

        const storedPassword = await fetchPassword();

        if (storedPassword && enteredPassword === storedPassword) {
            console.log("Password correct. Showing content.");
            document.getElementById("protectedContent").style.display = "block";
            document.getElementById("loginSection").style.display = "none";
        } else {
            console.warn("Incorrect password. Redirecting.");
            alert("Incorrect password.");
            window.location.href = "https://google.com";
        }
    }

    function logout() {
        enteredPassword = ""; 
        location.reload(); 
    }

    document.addEventListener("DOMContentLoaded", () => {
        setTimeout(checkPassword, 250);
    });

    let baseTotalCost = 0;

    async function getRate() {
        let zip = document.getElementById("zipCodeInput").value;
        document.getElementById("rateOutput").innerText = "Fetching data...";

        if (!enteredPassword) {
            alert("Session expired. Please refresh and log in again.");
            return;
        }

        const url = `https://script.google.com/macros/s/AKfycby4DoYAGHU7NEmdO0U9n2gnrKNefON3nAeoNIOYSgc5PE3QaOSh_nxgtEJ10n63rhLH/exec?action=getRates&zip=${zip}&pw=${encodeURIComponent(enteredPassword)}`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (data && data.freightCost !== undefined && data.fuelCost !== undefined && data.totalCost !== undefined) {
                baseTotalCost = data.totalCost;

                document.getElementById("rateOutput").innerHTML = `
                    <strong>City:</strong> ${data.location} <br>
                    <strong>Freight Cost:</strong> $${data.freightCost.toFixed(2)}<br>
                    <strong>Fuel Cost:</strong> $${data.fuelCost.toFixed(2)}<br>
                    <strong>Base Total:</strong> $${data.totalCost.toFixed(2)}
                `;

                updateTotal();
            } else {
                document.getElementById("rateOutput").innerText = "Invalid data format received.";
            }
        } catch (error) {
            document.getElementById("rateOutput").innerText = "Error fetching data. Please try again later.";
            console.error("Error parsing JSON:", error);
        }
    }

    function updateTotal() {
        let extraCharges = 0;
        let details = "";

        const charges = {
            localOver: 50,
            standardOver: 100,
            excessiveOver: 130,
            stopUnder5: 75,
            stop5to15: 125,
            reefer: 50,
            hazMat: 75,
            yardMove: 50,
            portPrePull: 75,
            csxPrePull: 125,
            emptyYardToPort: 25
        };

        for (let key in charges) {
            if (document.getElementById(key).checked) {
                extraCharges += charges[key];
                details += `<br>+ $${charges[key].toFixed(2)} for ${document.getElementById(key).dataset.label}`;
            }
        }

        let newTotal = baseTotalCost + extraCharges;
        document.getElementById("totalCost").innerHTML = `
            <strong>Total Cost:</strong> $${newTotal.toFixed(2)} ${details}
        `;
    }
</script>
